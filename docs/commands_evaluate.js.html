<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Adding favicon -->
    

    <!-- Adding meta -->
    

    <!-- Adding external script-->
    

    <!-- Adding external style-->
    

    <!-- Adding scripts-->
    

    <!-- Adding style-->
    

    <!-- Adding overlay script-->
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/overlayscrollbars/1.13.0/js/OverlayScrollbars.min.js"
      integrity="sha512-5R3ngaUdvyhXkQkIqTf/k+Noq3phjmrqlUQyQYbgfI34Mzcx7vLIIYTy/K1VMHkL33T709kfh5y6R9Xy/Cbt7Q=="
      crossorigin="anonymous"></script>
    

    <!-- Adding overlay style-->
    


    <title>
      commands/evaluate.js
    </title>

    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/third-party/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/third-party/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/reset.css">
    <link type="text/css" rel="stylesheet" href="styles/clean-jsdoc-theme-base.css">
    <link type="text/css" rel="stylesheet" href="styles/clean-jsdoc-theme-dark.css">
    
    <svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
    style="display:none">
    <defs>
        <symbol id="copy-icon" viewbox="0 0 488.3 488.3">
            <g>
                <path
                    d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z" />
                <path
                    d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z" />
            </g>
        </symbol>
        <symbol id='search-icon' viewBox="0 0 512 512">
            <g>
                <g>
                    <path
                        d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z" />
                </g>
            </g>
            <g>
                <g>
                    <path
                        d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z" />
                </g>
            </g>
        </symbol>
        <symbol id="down-icon" viewBox="0 0 16 16">
            <path 
                fill-rule="evenodd" 
                clip-rule="evenodd" 
                d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"
            >
            </path>
        </symbol>
    </defs>
</svg>
  </head>

  <body>

    <nav class="navbar" id="navbar">
      <div class="navbar-heading" id="navbar-heading"><a href="index.html"><h2 class="navbar-heading-text">Pronto</h2></a></div><div class="search-box" id="search-box"><div class="search-box-input-container"><input class="search-box-input" type="text" placeholder="Search..." id="search-box-input" /><svg class="search-icon" alt="search-icon"><use xlink:href="#search-icon"></use></svg></div><div class="search-item-container" id="search-item-container"><ul class="search-item-ul" id="search-item-ul"></ul></div></div><div class="sidebar-main-content" id="sidebar-main-content"><ul><li class="menu-li"><a href='https://github.com/JamesNZL/Pronto' class=' menu-link' id='' target='_blank'>GitHub Repository</a></li></ul><div class="accordion collapsed" id="4184347" > <h3 class="accordion-heading">Modules<svg><use xlink:href="#down-icon"></use></svg></h3><ul class="accordion-content"><li class="accordion-list" id=""><a href="module-commands.html">commands</a></li><li class="accordion collapsed child" id=6279925><div class="accordion-heading child"><a href="module-commands_approve.html">commands/approve</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="module-commands_approve.html#~processMentions">processMentions</a></li></ul></li><li class="accordion-list" id=""><a href="module-commands_archive.html">commands/archive</a></li><li class="accordion collapsed child" id=7108378><div class="accordion-heading child"><a href="module-commands_assign.html">commands/assign</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="module-commands_assign.html#~getUserInput">getUserInput</a></li><li data-type='method'><a href="module-commands_assign.html#~msgPrompt">msgPrompt</a></li><li data-type='method'><a href="module-commands_assign.html#~processMentions">processMentions</a></li><li data-type='method'><a href="module-commands_assign.html#~whileLoop">whileLoop</a></li></ul></li><li class="accordion-list" id=""><a href="module-commands_attendance.html">commands/attendance</a></li><li class="accordion-list" id=""><a href="module-commands_connected.html">commands/connected</a></li><li class="accordion collapsed child" id=5501139><div class="accordion-heading child"><a href="module-commands_evaluate.html">commands/evaluate</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="module-commands_evaluate.html#~convertToString">convertToString</a></li><li data-type='method'><a href="module-commands_evaluate.html#~findBreakIndex">findBreakIndex</a></li><li data-type='method'><a href="module-commands_evaluate.html#~removeSensitive">removeSensitive</a></li></ul></li><li class="accordion-list" id=""><a href="module-commands_help.html">commands/help</a></li><li class="accordion-list" id=""><a href="module-commands_leave.html">commands/leave</a></li><li class="accordion-list" id=""><a href="module-commands_leavefor.html">commands/leavefor</a></li><li class="accordion collapsed child" id=9779733><div class="accordion-heading child"><a href="module-commands_lesson.html">commands/lesson</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="module-commands_lesson.html#~getNumberInput">getNumberInput</a></li><li data-type='method'><a href="module-commands_lesson.html#~processMentions">processMentions</a></li><li data-type='method'><a href="module-commands_lesson.html#~serialiseResources">serialiseResources</a></li></ul></li><li class="accordion-list" id=""><a href="module-commands_ping.html">commands/ping</a></li><li class="accordion-list" id=""><a href="module-commands_purge.html">commands/purge</a></li><li class="accordion-list" id=""><a href="module-commands_restart.html">commands/restart</a></li><li class="accordion-list" id=""><a href="module-commands_seen.html">commands/seen</a></li><li class="accordion-list" id=""><a href="module-commands_uptime.html">commands/uptime</a></li></ul> </div><div class="accordion collapsed" id="5940476" > <h3 class="accordion-heading">Namespaces<svg><use xlink:href="#down-icon"></use></svg></h3><ul class="accordion-content"><li class="accordion collapsed child" id=2131040><div class="accordion-heading child"><a href="handlers.html">handlers</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="handlers.html#.commandLoader">commandLoader</a></li></ul></li><li class="accordion-list" id=""><a href="models.html">models</a></li><li class="accordion-list" id=""><a href="modules.html">modules</a></li></ul> </div>
      

    </nav>
    <div class="navbar-ham" id="navbar-ham">
      <div>
        <div class="first"></div>
        <div class="second"></div>
        <div class="third"></div>
      </div>
    </div>

    <div id="main" class="main-content">
      
      <h1 id='page-title' class="page-title">
        commands/evaluate.js
      </h1>
      

      



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* eslint-disable no-unused-vars */
'use strict';

const Discord = require('discord.js');
const { commandError, deleteMsg, dateTimeGroup, jsCodeBlock, sendMsg, ...modules } = require('../modules');
const handlers = require('../handlers');

/**
 * Attach the command.execute() function to command object
 * @module commands/evaluate
 * @param {Discord.Guild} guild The guild that the member shares with the bot
 * @returns {Promise&lt;Object.&lt;string, string | string[] | boolean | Function>>} The complete command object with a command.execute() property
 */
module.exports = async guild => {
	const { commands: { evaluate, ...commands }, colours, _doc: settings, ...db } = await require('../handlers/database')(guild);
	const { database } = require('../handlers');

	/**
	 * Evaluate Javascript code directly from a Discord message
	 * @param {Discord.Message} msg The \&lt;Message> that executed the command
	 * @param {string[]} args The command arguments
	 */
	evaluate.execute = async (msg, args) => {
		const { bot } = require('../pronto');

		// Parse the short flags from the message, which consist of single letters that may be joined together under a single '-'
		// Construct a string[] of each individual flag letter
		const shortFlags = args.filter(arg => arg.match(/(?&lt;![-a-zA-Z])-[A-z]+(?![\s\S]*})/g))
			.flatMap(flags => [...flags.replace('-', '')]);

		// Flag for whether to display the evaluated result in a code block
		const codeBlock = !(args.includes('--no-code') || args.includes('--plain') || shortFlags.includes('P'));

		// Flag for whether to supress result
		const silent = (args.includes('--silent') || shortFlags.includes('s'));

		// Flag for whether to delete the command message
		if (args.includes('--delete') || shortFlags.includes('d')) deleteMsg(msg);

		// Filter out all flags from the message prior to evaluation
		// Use regex to ensure only flags containing letters are filtered, and not numbers or standalone '-' characters
		args = args.filter(arg => !arg.match(/(?&lt;!(?&lt;!--\w*)[a-zA-Z])-{1,2}[a-zA-Z]+/g));

		// If the arguments contain a codeblock, separate arguments by newlines rather than spaces, and filter out the codeblocks
		if (args.includes('```')) args = args.join(' ').split('\n').filter(arg => !arg.includes('```'));

		// If there is no code to evaluate, return an error
		if (args.length === 0) return commandError(msg, 'You must enter something to evaluate.', evaluate.error);

		// Join the processed arguments together to form the code to evaluate
		const code = args.join(' ');

		try {
			// Initialise an embed
			const embed = new Discord.MessageEmbed();

			// Only evaluate the code if there is no attempt to extract the bot token
			let result = (!code.toLowerCase().includes('token'))
				? await eval(`(async () => { return ${code} })()`)
				: '*'.repeat(bot.token.length);

			// If the embed has been modified, automatically send it into the message channel
			if (code.includes('embed.')) sendMsg(msg.channel, { embeds: [embed] });

			// Supress result if flag was present
			if (silent) return;

			// If the evaluated result is not a string, convert it
			if (typeof result !== 'string') result = convertToString(result);

			// Attempt to remove any sensitive information from evaluated result
			// WARNING: This is primarily to prevent erroneous output, and IS NOT a robust implementation
			result = removeSensitive(result);

			// Pass the evaluated result into msgSplit(), breaking at the '},' substring
			// Remove any existing codeblocks, so they can be added again after the string has been split
			msgSplit(result.replace(/```j?s?/g, ''), '},');
		}

		// If there is an issue in the evaluation of the code, pass it into msgSplit(), breaking at the ')' substring
		catch (error) { msgSplit(error.stack, ')'); }

		/**
		 * Split a string into the necessary number of messages to accommodate for Discord's message character limit, splitting at a specified convenient substring
		 * @param {string} str The string to split into (potentially) multiple messages
		 * @param {string} [substr] The substring at which to break
		 */
		function msgSplit(str, substr) {
			// Loop while the string has not yet been sent in its entirety
			while (str) {
				// The maximum index at which to break the message
				// This is the maximum character limit of a Discord &lt;Message>
				const MAXIMUM_INDEX = 2000;

				// Use the codeblock boolean flag to determine whether to wrap result in a codeblock
				// If so, ensure the MAXIMUM_INDEX accounts for the codeblock characters
				const breakIndex = (codeBlock)
					? findBreakIndex(str, substr, MAXIMUM_INDEX)
					: findBreakIndex(str, substr, MAXIMUM_INDEX - '```js\n```'.length);

				// Wrap the message in a codeblock if flag is true, and send the message payload
				(codeBlock)
					? sendMsg(msg.channel, { content: jsCodeBlock(str.substr(0, breakIndex)) })
					: sendMsg(msg.channel, { content: str.substr(0, breakIndex) });

				// Remove the sent message content from the string before next iteration
				str = str.substr(breakIndex);
			}
		}
	};

	return evaluate;
};

/**
 * Convert an object (or other non-string type) to its string representation
 * @param {Object | *} toConvert An object, or any other data type, to be inspected and converted into a string
 * @returns {string} A string representation of the input
 */
function convertToString(toConvert) {
	// Use util.inspect() to inspect and convert the data type to a string
	return require('util').inspect(toConvert);
}

/**
 * Censor sensitive information from an input string, and return the result
 * @param {string} str The string to be censored
 * @returns {string} The resultant censored string
 */
function removeSensitive(str) {
	// Parse the githook through convertToString()
	const githook = convertToString(process.env.githook);
	// string[] of highly sensitive information to be censored
	// WARNING: This IS NOT a comprehensive or robust list
	// Strip the opening and closing {} from parsed githook string
	const sensitives = [process.env.TOKEN, githook.substr(1, githook.length - 2), process.env.SECRET, process.env.MONGOURI];

	// Loop through each sensitive string
	for (let i = 0; i &lt; sensitives.length; i++) {
		// Replace any occurences of the sensitive string with '*'
		// WARNING: This filter DOES NOT cover substrings of sensitive strings
		str = str.replace(new RegExp(sensitives[i], 'g'), '*'.repeat(sensitives[i].length));
	}

	// Return the censored string
	return str;
}

/**
 * Find the last occurence of a given substring within a string to ensure a comfortable message split position
 * @param {string} str The string to search within
 * @param {?string} substr The substring at which to break
 * @param {number} maximumIndex The maximum length that the message can be
 * @returns {number} The index of the last occurence of the substring
 */
function findBreakIndex(str, substr, maximumIndex) {
	// Find the last occurence of the specified substring, but before the maximum index (accounting for the length of the substring itself)
	const substrIndex = str.lastIndexOf(substr, maximumIndex - substr.length);
	const hasSubstr = substrIndex !== -1;

	// Find the last occurence of a ' ' character as a fallback
	const spaceIndex = str.lastIndexOf(' ', maximumIndex - 1);
	const hasSpace = spaceIndex !== -1;

	return (str.length > maximumIndex)
		// If the length of the string is greater than the maximum index and must be broken, follow the truthy tree
		? (hasSubstr)
			// If the substring is present, return the index immediately after the last occurence of the substring
			? substrIndex + substr.length
			: (hasSpace)
				// Otherwise, return the index of the last space character if present
				? spaceIndex
				// If there is not a space character, break at the maximum index
				: maximumIndex
		// Otherwise, simply return the maximum index
		: maximumIndex;
}</code></pre>
        </article>
    </section>




    </div>

    <footer class="footer" id="footer">
      
    </footer>

    <script src="scripts/third-party/prettify.js"></script>
    <script src="scripts/third-party/lang-css.js"></script>
    <script type="text/javascript" src="scripts/misc.js"></script>

    <script>prettyPrint();</script>
    <script src="scripts/linenumber.js"></script>
    <script src="scripts/fix-code-block.js"></script>
    <script src="scripts/fix-navbar.js"></script>
    
      <script src="scripts/search.js"></script>
      <script src="scripts/third-party/fuse.js"></script>
      <script>
        var list = [{"title":"commands","link":"<a href=\"module-commands.html\">commands</a>"},{"title":"commands/approve","link":"<a href=\"module-commands_approve.html\">commands/approve</a>"},{"title":"module:commands/approve~processMentions","link":"<a href=\"module-commands_approve.html#~processMentions\">module:commands/approve~processMentions &rtrif; undefined</a>"},{"title":"commands/archive","link":"<a href=\"module-commands_archive.html\">commands/archive</a>"},{"title":"commands/assign","link":"<a href=\"module-commands_assign.html\">commands/assign</a>"},{"title":"module:commands/assign~getUserInput","link":"<a href=\"module-commands_assign.html#~getUserInput\">module:commands/assign~getUserInput &rtrif; undefined</a>"},{"title":"module:commands/assign~msgPrompt","link":"<a href=\"module-commands_assign.html#~msgPrompt\">module:commands/assign~msgPrompt &rtrif; undefined</a>"},{"title":"module:commands/assign~processMentions","link":"<a href=\"module-commands_assign.html#~processMentions\">module:commands/assign~processMentions &rtrif; undefined</a>"},{"title":"module:commands/assign~whileLoop","link":"<a href=\"module-commands_assign.html#~whileLoop\">module:commands/assign~whileLoop &rtrif; undefined</a>"},{"title":"commands/attendance","link":"<a href=\"module-commands_attendance.html\">commands/attendance</a>"},{"title":"commands/connected","link":"<a href=\"module-commands_connected.html\">commands/connected</a>"},{"title":"commands/evaluate","link":"<a href=\"module-commands_evaluate.html\">commands/evaluate</a>"},{"title":"module:commands/evaluate~convertToString","link":"<a href=\"module-commands_evaluate.html#~convertToString\">module:commands/evaluate~convertToString &rtrif; undefined</a>"},{"title":"module:commands/evaluate~findBreakIndex","link":"<a href=\"module-commands_evaluate.html#~findBreakIndex\">module:commands/evaluate~findBreakIndex &rtrif; undefined</a>"},{"title":"module:commands/evaluate~removeSensitive","link":"<a href=\"module-commands_evaluate.html#~removeSensitive\">module:commands/evaluate~removeSensitive &rtrif; undefined</a>"},{"title":"commands/help","link":"<a href=\"module-commands_help.html\">commands/help</a>"},{"title":"commands/leave","link":"<a href=\"module-commands_leave.html\">commands/leave</a>"},{"title":"commands/leavefor","link":"<a href=\"module-commands_leavefor.html\">commands/leavefor</a>"},{"title":"commands/lesson","link":"<a href=\"module-commands_lesson.html\">commands/lesson</a>"},{"title":"module:commands/lesson~getNumberInput","link":"<a href=\"module-commands_lesson.html#~getNumberInput\">module:commands/lesson~getNumberInput &rtrif; undefined</a>"},{"title":"module:commands/lesson~processMentions","link":"<a href=\"module-commands_lesson.html#~processMentions\">module:commands/lesson~processMentions &rtrif; undefined</a>"},{"title":"module:commands/lesson~serialiseResources","link":"<a href=\"module-commands_lesson.html#~serialiseResources\">module:commands/lesson~serialiseResources &rtrif; undefined</a>"},{"title":"commands/ping","link":"<a href=\"module-commands_ping.html\">commands/ping</a>"},{"title":"commands/purge","link":"<a href=\"module-commands_purge.html\">commands/purge</a>"},{"title":"commands/restart","link":"<a href=\"module-commands_restart.html\">commands/restart</a>"},{"title":"commands/seen","link":"<a href=\"module-commands_seen.html\">commands/seen</a>"},{"title":"commands/uptime","link":"<a href=\"module-commands_uptime.html\">commands/uptime</a>"},{"title":"handlers","link":"<a href=\"handlers.html\">handlers</a>"},{"title":"handlers.commandLoader","link":"<a href=\"handlers.html#.commandLoader\">handlers.commandLoader &rtrif; undefined</a>"},{"title":"models","link":"<a href=\"models.html\">models</a>"},{"title":"modules","link":"<a href=\"modules.html\">modules</a>"}];
        var options = {"shouldSort":true,"threshold":0.4,"location":0,"distance":100,"maxPatternLength":32,"minMatchCharLength":1}
          setupSearch(list, options)
      </script>
    

    

    

    

    
    <script type="text/javascript">
    var option = JSON.parse('{"option":{}}')
      document.addEventListener("DOMContentLoaded", function () {
        OverlayScrollbars(document.querySelectorAll('body'), option.option || {});
      });
    </script>
    


  </body>

</html>
